# MCP Fixes - Note-Task Linking and Recurring Calendar Events

**Date:** 2026-02-03

## Issues Identified

### Issue 1: Note-to-Task Linking Missing from MCP
The MCP's `create_task` and `update_task` tools didn't include the `note_ids` parameter that the backend service supports. When Claude created a note and task separately via MCP, there was no way to link them like the "Link note" button does in the UI.

### Issue 2: Recurring Calendar Events Not Showing
The MCP's `get_calendar_events` used a simple query:
```python
select(CalendarEvent).where(CalendarEvent.start_time.between(start, end))
```

This failed for recurring events because:
- Master events have `start_time` set to the **first occurrence** (may be months in the past)
- Virtual instances are **generated on-the-fly** by expanding the RRULE
- The REST endpoint `/calendar/events` does proper 3-phase expansion, but MCP bypassed this

## Implementation

### Changes to `api/mcp/server.py`

1. **Added imports:**
   - `zoneinfo` for timezone handling
   - `dateutil.rrule.rrulestr` for RRULE expansion
   - `TaskNote` model for note-task linking

2. **Updated `create_task` tool:**
   - Added `note_ids` parameter to input schema
   - Handler now creates `TaskNote` records for each provided note_id
   - Returns confirmation with linked note titles

3. **Updated `update_task` tool:**
   - Added `note_ids` parameter to input schema
   - Handler replaces all linked notes when `note_ids` is provided
   - Returns confirmation with linked note titles

4. **Added new `link_note_to_task` tool:**
   - Dedicated tool for linking a single note to a task
   - Doesn't replace existing links (additive)
   - Validates both task and note exist
   - Prevents duplicate links

5. **Fixed `get_calendar_events` to properly expand recurring events:**
   - Phase 1: Query non-recurring events with date filter
   - Phase 2: Query all recurring masters (no date filter), expand RRULEs into date range
   - Phase 3: Query exception instances with date filter
   - Handles timezone-aware RRULE expansion (preserves DST)
   - Builds exception map to override specific occurrences
   - Sorts and limits results

6. **Fixed `get_dashboard` with same recurring event expansion:**
   - Now properly shows today's recurring events
   - Uses same expansion logic as `get_calendar_events`

## New Tool Schema

```json
{
  "name": "link_note_to_task",
  "description": "Link an existing note to an existing task. Creates a backlink without removing other linked notes.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "task_id": {"type": "string", "description": "Task ID to link to"},
      "note_id": {"type": "string", "description": "Note ID to link"}
    },
    "required": ["task_id", "note_id"]
  }
}
```

## Testing Checklist

- [ ] Create task with `note_ids` parameter - verify notes are linked
- [ ] Update task with `note_ids` parameter - verify notes are replaced
- [ ] Use `link_note_to_task` - verify single note is added without removing others
- [ ] Query calendar events for a week with recurring events - verify they appear
- [ ] Get dashboard on a day with recurring events - verify they appear
- [ ] Test timezone handling with events in different timezones

---

# Additional MCP Linking Fixes (Session 2)

**Date:** 2026-02-03

## Gaps Identified

After auditing the MCP server for completeness of linking operations, found several additional gaps where the backend supports functionality that isn't exposed via MCP.

### Gap 1: update_note missing project_id
The backend `update_note()` service already accepts `project_id`, but the MCP tool didn't expose it. Claude couldn't change a note's project after creation.

### Gap 2: No way to query note links/backlinks
The REST endpoint `GET /notes/{id}/links` returns outgoing and incoming links for a note, but MCP had no equivalent tool. Claude couldn't discover what links to/from a note.

### Gap 3: No way to query task links
No way to see which notes are linked to a task (either explicitly via TaskNote or via `[[task:id]]` wiki-links in note content).

## Implementation

### Changes to `api/mcp/server.py`

1. **Added `NoteLink` import** for querying note-to-note and note-to-task links

2. **Updated `update_note` tool schema:**
   - Added `project_id` parameter with description "New project ID (use empty string to unassign)"

3. **Updated `_update_note` handler:**
   - Passes `project_id` to `service_update_note()`
   - Handles empty string as "unassign from project" (sets to None)
   - Response now includes project info when set

4. **Added `get_note_links` tool:**
   - Returns all outgoing links (notes, tasks, events this note references)
   - Returns all incoming links (notes that reference this note, tasks created from this note)
   - Formatted as markdown with sections for outgoing/incoming

5. **Added `get_task_links` tool:**
   - Returns explicitly linked notes (via TaskNote table)
   - Returns notes that reference this task via `[[task:task_id]]` wiki-links
   - Deduplicates notes that appear in both categories

## New Tool Schemas

```json
{
  "name": "get_note_links",
  "description": "Get all links for a note: outgoing (this note links to) and incoming (links to this note). Includes linked notes, tasks, and events.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "note_id": {"type": "string", "description": "Note ID"}
    },
    "required": ["note_id"]
  }
}
```

```json
{
  "name": "get_task_links",
  "description": "Get all notes linked to a task, including both explicit links and wiki-link references ([[task:id]]).",
  "inputSchema": {
    "type": "object",
    "properties": {
      "task_id": {"type": "string", "description": "Task ID"}
    },
    "required": ["task_id"]
  }
}
```

## Testing Checklist (Session 2)

- [ ] Update note with `project_id` - verify project changes
- [ ] Update note with empty string `project_id` - verify project is unassigned
- [ ] Create note with wiki-links, call `get_note_links` - verify outgoing links shown
- [ ] Create note that links to another, call `get_note_links` on target - verify incoming links
- [ ] Create task, link notes via `link_note_to_task`, call `get_task_links` - verify explicit links
- [ ] Create note with `[[task:id]]` content, call `get_task_links` - verify wiki-link references
